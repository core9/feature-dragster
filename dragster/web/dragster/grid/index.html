<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="author" content="Kilian Valkhof" />
<title>gridBuilder.js!</title>
<link href="sen.css" rel="stylesheet" type="text/css" />
<style type="text/css">
#wrap {
	/*this bit is for show only*/
	width: 760px;
	margin: auto;
	padding: 1.5em 10px;
	overflow: hidden;
}
</style>

<script type="text/javascript" src="jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="localforage.min.js"></script>
<script type="text/javascript" src="gridBuilder.js"></script>
<script type="text/javascript">
	$(document).ready(
			function() {

				var dbKeyExists = false;

				/**
				 * Check if a database exists
				 * @param {string} name Database name
				 * @param {function} callback Function to return the response
				 * @returns {bool} True if the database exists
				 */
				function databaseExists(name, callback) {
					var dbExists = true;
					var request = window.indexedDB.open(name);

					request.onupgradeneeded = function(e) {
						if (request.result.version === 1) {
							dbExists = false;
							window.indexedDB.deleteDatabase(name);
							if (callback)
								callback(dbExists);
						}

					};
					request.onsuccess = function(e) {
						if (dbExists) {
							if (callback)
								callback(dbExists);
						}
					};
				}
				;

				var name = "dbGridster";
				databaseExists(name, function(exists) {
					if (exists) {

						var req = window.indexedDB.open(name);
						req.onupgradeneeded = function(event) {
							var db = event.target.result;
							var transaction = db.transaction([ name ]);
							var objectStore = transaction.objectStore(name);
							var request2 = objectStore.get("exists");
							request2.onerror = function(event) {
								// Handle errors!
								console.log("does not exists");
							};
							request2.onsuccess = function(event) {
								// Do something with the request.result!
								alert("exists is " + request2.result.name);
							};
						}

						console.debug("database " + name + " exists");
					} else {
						console.debug("database " + name + " does not exists");
					}
				});

				function updateGrid(state) {
					$("body").destroyGrid();
					$("body").gridBuilder({
						color : state.color,
						secondaryColor : state.secondaryColor,
						vertical : parseInt(state.vertical),
						horizontal : parseInt(state.horizontal),
						gutter : parseInt(state.gutter),
					});

				}

				function saveToLocal(state) {

					updateGrid(state);

					localforage.config({
						version : 3,
						name : 'dbGridster',
						storeName : 'grids',
						description : 'some description'
					});




					localforage.ready(function() {

						var background = $('body').css('background-image');
						if (state.name == '')
							return;
						localforage.setItem(state.name, background);
						localforage.keys(function(keys) {
							console.log(keys);
						});

					});
				}

				(function($) {
					"use strict";
					var gridster = {
						body : $("body"),
						gutter : $("[name='gutter']"),
						button : $("button"),
						config : {
							useCaching : true,
							language : "en"
						},
						load : function() {
						},
						save : function(event) {
							event.preventDefault();
							var state = {
								name : $('input[name="name"]').val(),
								color : $('input[name="color"]').val(),
								secondaryColor : $(
										'input[name="secondaryColor"]').val(),
								vertical : $('input[name="vertical"]').val(),
								horizontal : $('input[name="horizontal"]')
										.val(),
								gutter : $('input[name="gutter"]').val()
							}
							if (dbKeyExists) {
								saveToLocal(state);
							} else {
								console.log("Key does not exists");

								localforage.config({
									version : 3,
									name : 'dbGridster',
									storeName : 'grids',
									description : 'some description'
								});

								
					            localforage.keys(function(k) {
					                console.log(k.toString());
					                console.log('empty ????');
					                
					              });
								
								localforage.clear();
								window.indexedDB.deleteDatabase("dbGridster");

								saveToLocal(state);
							}
						},
						clear : function() {
							this.body.destroyGrid();
						},
						start : function() {
							this.body.gridBuilder();
							this.button.click(this.save);
							//console.log(this.gutter.val());
						}
					}
					gridster.start();
				})(jQuery);

			});
</script>

</head>
<body>



	<div
		style="margin: 0 auto; margin-top: 200px; width: 200px; height: 100px;">
		<a class="menu" href="../">Editor</a>
		<form>
			<input type="text" name="name"></input>
			<input type="color" name="color"> <input type="color"
				name="secondaryColor"> <input type="number" name="vertical"
					value="18"> <input type="number" name="horizontal"
						value="140"> <input type="number" name="gutter" value="40">
								<button type="submit" name="save" value="true">to save double click</button>
		</form>

	</div>
</body>
</html>

